#!/bin/bash
# Script de instalação do Unbound com root hints - Debian 12 (IPv4 + IPv6 + Firewall)
# Autor: Thiago Moreira (adaptado pelo ChatGPT)

set -e

echo "=== Atualizando pacotes ==="
apt update && apt upgrade -y

echo "=== Instalando Unbound e UFW (firewall) ==="
apt install -y unbound curl ufw

echo "=== Baixando Root Hints da IANA ==="
curl -o /var/lib/unbound/root.hints https://www.internic.net/domain/named.root

echo "=== Criando configuração do Unbound ==="
cat > /etc/unbound/unbound.conf.d/root.conf <<EOF
server:
    verbosity: 1

    # Interfaces (IPv4 e IPv6)
    interface: 0.0.0.0
    interface: ::0

    # Redes autorizadas (ajuste conforme sua rede interna)
    access-control: 127.0.0.0/8 allow
    access-control: ::1 allow
    access-control: 192.168.0.0/16 allow
    access-control: 172.16.0.0/12 allow
    access-control: 10.0.0.0/8 allow
    access-control: 100.64.0.0/10 allow
    access-control: fc00::/7 allow
    access-control: fe80::/10 allow

    # Root hints
    root-hints: "/var/lib/unbound/root.hints"

    # Segurança
    hide-identity: yes
    hide-version: yes
    harden-glue: yes
    harden-dnssec-stripped: yes
    harden-referral-path: yes
    unwanted-reply-threshold: 10000000

    # Performance
    num-threads: 2
    msg-cache-size: 50m
    rrset-cache-size: 100m
    cache-min-ttl: 3600
    cache-max-ttl: 86400

    # DNS Privacy
    qname-minimisation: yes
    prefetch: yes
    aggressive-nsec: yes
    use-caps-for-id: yes
EOF

echo "=== Testando configuração do Unbound ==="
unbound-checkconf

echo "=== Habilitando e iniciando o serviço ==="
systemctl enable unbound
systemctl restart unbound

echo "=== Configurando firewall (UFW) ==="
ufw allow ssh        # Mantém acesso remoto
ufw allow 53/udp     # Libera DNS UDP
ufw allow 53/tcp     # Libera DNS TCP
ufw enable

echo "=== Testando resolução de DNS ==="
dig @127.0.0.1 www.google.com || true
dig @::1 www.google.com || true

echo "=== Instalação concluída com sucesso! ==="
